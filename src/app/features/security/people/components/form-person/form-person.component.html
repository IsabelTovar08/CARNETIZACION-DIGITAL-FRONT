<div class="form-container">
  <mat-card class="stepper-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
        {{ isEditMode ? 'Editar mi informaci√≥n' : 'Registro de Persona' }}
      </mat-card-title>
      <mat-card-subtitle>
        {{ isEditMode ? 'Actualiza tus datos personales registrados en el sistema.' :
        'Complete todos los pasos para registrar una nueva persona.' }}
      </mat-card-subtitle>


    </mat-card-header>

    <div *ngIf="isEditMode && isEditableBlocked" class="lock-overlay">
      <p>üîí Debes verificar tu contrase√±a para editar tus datos.</p>
      <button mat-raised-button color="primary" (click)="abrirModal()">
        Verificar contrase√±a
      </button>
    </div>
    <mat-card-actions *ngIf="isEditMode && !isEditableBlocked">
      <button mat-raised-button color="primary" (click)="onChangePassword()" class="password-btn">
        <mat-icon>vpn_key</mat-icon>
        Cambiar Contrase√±a
      </button>
    </mat-card-actions>
    <mat-card-content>
      <mat-stepper [linear]="isLinear" #stepper orientation="horizontal" class="custom-stepper">
        <!-- Paso 1: Informaci√≥n Personal B√°sica -->
        <mat-step [stepControl]="personalInfoForm" errorMessage="Complete la informaci√≥n personal">
          <form [formGroup]="personalInfoForm">
            <ng-template matStepLabel>Informaci√≥n Personal</ng-template>

            <div class="step-content">
              <h3 class="step-title">Datos Personales</h3>

              <div class="form-row">

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Primer Nombre</mat-label>
                  <input matInput placeholder="Ingrese su primer nombre" formControlName="firstName" required>
                  <mat-icon matSuffix>person</mat-icon>
                  <mat-error *ngIf="personalInfoForm.get('firstName')?.hasError('required')">
                    El primer nombre es requerido
                  </mat-error>
                </mat-form-field>
              </div>


              <div class="form-row">

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Segundo Nombre</mat-label>
                  <input matInput placeholder="Segundo nombre (opcional)" formControlName="middleName">
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Primer Apellido</mat-label>
                  <input matInput placeholder="Primer apellido" formControlName="lastName" required>
                  <mat-error *ngIf="personalInfoForm.get('lastName')?.hasError('required')">
                    El apellido es requerido
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Segundo Apellido</mat-label>
                  <input matInput placeholder="Segundo apellido (opcional)" formControlName="secondLastName">
                </mat-form-field>
              </div>
            </div>

            <div class="step-actions">
              <button mat-raised-button color="primary" matStepperNext [disabled]="!personalInfoForm.valid">
                <mat-icon>navigate_next</mat-icon>
                Siguiente
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Paso 2: Documentaci√≥n -->
        <mat-step [stepControl]="documentForm" errorMessage="Complete la informaci√≥n de documentaci√≥n">
          <form [formGroup]="documentForm">
            <ng-template matStepLabel>Documentaci√≥n</ng-template>

            <div class="step-content">
              <h3 class="step-title">Informaci√≥n de Identificaci√≥n</h3>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Tipo de Documento</mat-label>
                  <mat-select formControlName="documentTypeId" required>
                    <mat-option *ngFor="let docType of documentTypes" [value]="docType.id">
                      {{docType.name}} - {{docType.description}}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix>badge</mat-icon>
                  <mat-error *ngIf="documentForm.get('documentTypeId')?.hasError('required')">
                    Seleccione un tipo de documento
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>N√∫mero de Identificaci√≥n</mat-label>
                  <input matInput placeholder="N√∫mero de documento" formControlName="documentNumber" required>
                  <mat-error *ngIf="documentForm.get('documentNumber')?.hasError('required')">
                    El n√∫mero de identificaci√≥n es requerido
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Tipo de Sangre</mat-label>
                  <mat-select formControlName="bloodTypeId" required>
                    <mat-option *ngFor="let bloodType of bloodTypes" [value]="bloodType.id">
                      {{bloodType.name}}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix>bloodtype</mat-icon>
                  <mat-error *ngIf="documentForm.get('bloodTypeId')?.hasError('required')">
                    Seleccione un tipo de sangre
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <div class="step-actions">
              <button mat-stroked-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!documentForm.valid">
                <mat-icon>navigate_next</mat-icon>
                Siguiente
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Paso 3: Informaci√≥n de Contacto -->
        <mat-step [stepControl]="contactForm" errorMessage="Complete la informaci√≥n de contacto">
          <form [formGroup]="contactForm">
            <ng-template matStepLabel>Informaci√≥n de Contacto</ng-template>

            <div class="step-content">
              <h3 class="step-title">Datos de Contacto</h3>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Tel√©fono</mat-label>
                  <input matInput placeholder="N√∫mero de tel√©fono" formControlName="phone" required>
                  <mat-icon matSuffix>phone</mat-icon>
                  <mat-error *ngIf="contactForm.get('phone')?.hasError('required')">
                    El tel√©fono es requerido
                  </mat-error>
                  <mat-error *ngIf="contactForm.get('phone')?.hasError('pattern')">
                    Formato de tel√©fono inv√°lido
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Correo Electr√≥nico</mat-label>
                  <input matInput placeholder="correo@ejemplo.com" formControlName="email" required>
                  <mat-icon matSuffix>email</mat-icon>
                  <mat-error *ngIf="contactForm.get('email')?.hasError('required')">
                    El correo electr√≥nico es requerido
                  </mat-error>
                  <mat-error *ngIf="contactForm.get('email')?.hasError('email')">
                    Formato de correo inv√°lido
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Direcci√≥n</mat-label>
                  <textarea matInput placeholder="Direcci√≥n completa" formControlName="address" rows="3"></textarea>
                  <mat-icon matSuffix>home</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Departamento</mat-label>
                  <mat-select formControlName="deparmentId" required>
                    <mat-option *ngFor="let deparment of deparments" [value]="deparment.id">
                      {{deparment.name}}
                    </mat-option>
                  </mat-select>
                  <mat-icon matSuffix>location_deparment</mat-icon>
                  <mat-error *ngIf="contactForm.get('deparmentId')?.hasError('required')">
                    Seleccione un deparmento
                  </mat-error>
                </mat-form-field>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Ciudad</mat-label>
                  <mat-select formControlName="cityId" required>
                    <mat-option *ngFor="let city of cities" [value]="city.id">{{ city.name }}</mat-option>
                  </mat-select>
                  <mat-icon matSuffix>location_city</mat-icon>
                  <mat-error *ngIf="contactForm.get('cityId')?.hasError('required')">
                    Seleccione una ciudad
                  </mat-error>
                </mat-form-field>

              </div>
            </div>

            <div class="step-actions">
              <button mat-stroked-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!contactForm.valid">
                <mat-icon>navigate_next</mat-icon>
                Siguiente
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Paso 4: Usuario -->
        <mat-step [stepControl]="userForm" errorMessage="Complete la informaci√≥n de usuario">
          <form [formGroup]="userForm">
            <ng-template matStepLabel>Usuario</ng-template>
            <div class="step-content">
              <h3 class="step-title">Informaci√≥n de Usuario</h3>
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Email</mat-label>
                  <input matInput value="{{getEmail}}" readonly>
                  <mat-icon matSuffix>account_circle</mat-icon>
                </mat-form-field>
              </div>
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nombre de Usuario (Opcional)</mat-label>
                  <input matInput placeholder="Nombre de usuario √∫nico" formControlName="username">
                  <mat-icon matSuffix>account_circle</mat-icon>
                  <mat-hint>El nombre de usuario debe ser √∫nico en el
                    sistema</mat-hint>
                  <mat-error *ngIf="userForm.get('username')?.hasError('minlength')">
                    M√≠nimo 3 caracteres
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-row">
                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Contrase√±a</mat-label>
                  <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password" required>
                  <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
                    <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  <mat-error *ngIf="userForm.get('password')?.hasError('required')">
                    La contrase√±a es requerida
                  </mat-error>
                  <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
                    M√≠nimo 6 caracteres
                  </mat-error>
                  <mat-error *ngIf="userForm.get('password')?.hasError('strongPassword')">
                    Debe contener: may√∫scula, min√∫scula, n√∫mero y car√°cter especial
                  </mat-error>
                  <mat-hint>Debe incluir: may√∫scula, min√∫scula, n√∫mero y car√°cter especial</mat-hint>

                </mat-form-field>

                <mat-form-field appearance="outline" class="half-width">
                  <mat-label>Confirmar Contrase√±a</mat-label>
                  <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword"
                    required>
                  <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
                    <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('required')">
                    Confirme la contrase√±a
                  </mat-error>
                  <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('passwordMismatch')">
                    Las contrase√±as no coinciden
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <div class="step-actions">
              <button mat-stroked-button matStepperPrevious>
                <mat-icon>navigate_before</mat-icon>
                Anterior
              </button>
              <button mat-raised-button color="primary" matStepperNext [disabled]="!userForm.valid">
                <mat-icon>navigate_next</mat-icon>
                Siguiente
              </button>
            </div>
          </form>
        </mat-step>

        <!-- Paso 5: Confirmaci√≥n -->
        <mat-step>
          <ng-template matStepLabel>Confirmaci√≥n</ng-template>

          <div class="step-content confirmation-step">
            <div class="success-icon">
              <mat-icon color="primary">pending</mat-icon>
            </div>

            <h3 class="">¬°Confirma tus datos!</h3>
            <p class="confirmation-message">
              Revise la informaci√≥n a continuaci√≥n antes de finalizar.
            </p>

            <!-- Resumen de datos -->
            <mat-card class="summary-card">
              <mat-card-header>
                <mat-card-title>Resumen de Informaci√≥n</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-section">
                  <h4><mat-icon>person</mat-icon> Informaci√≥n Personal</h4>
                  <p><strong>Nombre:</strong> {{getFullName()}}</p>
                </div>

                <div class="summary-section">
                  <h4><mat-icon>badge</mat-icon> Documentaci√≥n</h4>
                  <p><strong>Documento:</strong> {{getDocumentTypeName()}} -
                    {{documentForm.get('documentNumber')?.value}}</p>
                  <p><strong>Tipo de Sangre:</strong>
                    {{getBloodTypeName()}}</p>
                </div>

                <div class="summary-section">
                  <h4><mat-icon>contact_mail</mat-icon> Contacto</h4>
                  <p><strong>Tel√©fono:</strong>
                    {{contactForm.get('phone')?.value}}</p>
                  <p><strong>Email:</strong>
                    {{contactForm.get('email')?.value}}</p>
                  <p><strong>Direcci√≥n:</strong>
                    {{contactForm.get('address')?.value}}</p>
                  <p><strong>Ciudad:</strong> {{getCityName()}}</p>
                </div>

                <div class="summary-section">
                  <h4><mat-icon>account_circle</mat-icon> Usuario</h4>
                  <p><strong>Username:</strong>
                    {{userForm.get('username')?.value}}</p>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="step-actions final-actions">
            <button mat-stroked-button matStepperPrevious>
              <mat-icon>navigate_before</mat-icon>
              Anterior
            </button>
            <button mat-stroked-button (click)="stepper.reset()" class="reset-btn">
              <mat-icon>refresh</mat-icon>
              Reiniciar
            </button>
            <button mat-raised-button color="primary" (click)="submitForm()" [disabled]="!isFormValid()">
              <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
              {{ isEditMode ? 'Actualizar mis datos' : 'Registrar Persona' }}
            </button>
          </div>
        </mat-step>
        <div *ngIf="isEditMode && isEditableBlocked" class="lock-overlay">
          <p>üîí Debes verificar tu contrase√±a para editar tus datos.</p>
          <button mat-raised-button color="primary" (click)="abrirModal()">
            Verificar contrase√±a
          </button>
        </div>
      </mat-stepper>
    </mat-card-content>
  </mat-card>


  <!-- ‚úÖ Modal para validaci√≥n de credenciales -->
  <app-generic-credincials *ngIf="isModalOpen" [isOpen]="isModalOpen"
    [userEmail]="contactForm.get('email')?.value || ''" (closeModal)="cerrarModal()"
    (validationSuccess)="onValidacionExitosa($event)">
  </app-generic-credincials>
</div>
